---
title: "hw11"
author: "Eric Lo"
date: '2024-05-24'
output: html_document
---

```{r}
library(readr)
library(tseries)
library(rugarch)
library(dplyr)
library(xts)
library(quantmod)
library(FinTS)
```
  
  
3.5
```{r}
# 讀取資料
data <- read.table("D:/財務時間序列/hw11/m-intc7308.txt")
data <- data[-1, ]
data$V2 <- as.numeric(data$V2)
data$V1 <- as.Date(data$V1, format="%Y%m%d")

# 將簡單回報率轉換為對數回報率
data$V2 <- log(1 + data$V2)

# 定義GARCH模型
spec <- ugarchspec(
  variance.model = list(model = "sGARCH", garchOrder = c(1, 1)),
  mean.model = list(armaOrder = c(0, 0), include.mean = TRUE),
  distribution.model = "norm"
)

# 擬合GARCH模型
fit <- ugarchfit(spec = spec, data = data$V2)

# 檢查模型擬合結果
print(fit)

# 設定預測點
forecast_origin <- which(data$V1 == as.Date("2008-12-31"))

if(length(forecast_origin) == 0) {
  stop("2008-12-31 not found in the date column.")
}

# 計算1步到5步的波動性預測
forecasts <- ugarchforecast(fit, n.ahead = 5, n.roll = nrow(data) - forecast_origin)

# 顯示波動性預測結果
print(forecasts)
```
  
  
3.10  
(a)
```{r}

# 讀取資料
data <- read.table("D:/財務時間序列/hw11/m-gmsp5008.txt")

# 刪除第一列
data <- data[-1, ]
names(data) <- c("date", "gm", "sp")

# 將日期轉換為日期格式
data$date <- as.Date(data$date, format="%Y%m%d")
data$gm =  as.numeric(data$gm)
data$sp =  as.numeric(data$sp)

# 將簡單回報率轉換為對數回報率
data$log_rtn <- log(1 + data$sp)
data$log_gm <- log(1 + data$gm)

# 定義GARCH模型
spec <- ugarchspec(
  variance.model = list(model = "sGARCH", garchOrder = c(1, 1)),
  mean.model = list(armaOrder = c(0, 0), include.mean = TRUE),
  distribution.model = "norm"
)

# 擬合GARCH模型
fit <- ugarchfit(spec = spec, data = data$log_rtn)

# 檢查模型擬合結果
print(fit)
```
  
(b)
```{r}
# 定義夏季月份
summer_months <- c(6, 7, 8)

# 添加夏季效應變量
data$summer_effect <- ifelse(as.numeric(format(data$date, "%m")) %in% summer_months, 1, 0)

# 檢查數據的基本統計量
summary(data$log_rtn)

# 繪製數據圖形檢查異常值
plot(data$log_rtn, type = "l")

# 定義包含夏季效應的GARCH模型，設置不同的分佈模型
spec_summer <- ugarchspec(
  variance.model = list(
    model = "sGARCH", 
    garchOrder = c(1, 1),
    external.regressors = matrix(data$summer_effect, ncol=1)
  ),
  mean.model = list(armaOrder = c(0, 0), include.mean = TRUE),
  distribution.model = "norm"  # 使用t分佈
)

# 使用不同的優化方法擬合包含夏季效應的GARCH模型
fit_summer <- ugarchfit(spec = spec_summer, data = data$log_rtn, solver = "nlminb")

# 檢查模型擬合結果
print(fit_summer)

# 提取模型參數
params <- coef(fit_summer)

# 檢查夏季效應變量的顯著性
summer_effect_param <- params["vxreg1"]
summer_effect_pvalue <-fit_summer@fit$robust.matcoef["vxreg1",4]

# 顯示結果
cat("夏季效應參數估計值:", summer_effect_param, "\n")
cat("夏季效應參數的p值:", summer_effect_pvalue, "\n")
```
  
(c)
```{r}
# 添加滯後收益
gm_returns_lag1 <- na.omit(lag(data$log_gm, 1))

# 定義包含滯後收益的GARCH模型
spec_lagged <- ugarchspec(
  variance.model = list(
    model = "sGARCH", 
    garchOrder = c(1, 1),
    external.regressors = as.matrix(gm_returns_lag1)
  ),
  mean.model = list(armaOrder = c(0, 0), include.mean = TRUE),
  distribution.model = "norm"  # 使用t分佈
)

# 擬合包含滯後收益的GARCH模型
fit_lagged <- ugarchfit(spec = spec_lagged, data = data$log_rtn[-1])
print(fit_lagged)

# 提取模型參數
params_baseline <- coef(fit)
params_lagged <- coef(fit_lagged)

# 檢查滯後收益參數的顯著性
lagged_effect_param <- params_lagged["vxreg1"]
lagged_effect_pvalue <- fit_lagged@fit$robust.matcoef["vxreg1", 4]

# 顯示結果
cat("滯後收益參數估計值:", lagged_effect_param, "\n")
cat("滯後收益參數的p值:", lagged_effect_pvalue, "\n")

# 比較AIC值
aic_baseline <- infocriteria(fit)["Akaike", ]
aic_lagged <- infocriteria(fit_lagged)["Akaike", ]

cat("基線模型的AIC值:", aic_baseline, "\n")
cat("包含滯後收益模型的AIC值:", aic_lagged, "\n")

if (aic_lagged < aic_baseline) {
  cat("包含滯後收益的模型更優。\n")
} else {
  cat("基線模型更優。\n")
}
```
  
  
3.12  
(a)
```{r}
# 讀取數據
data <- read.table("D:/財務時間序列/hw11/d-gmsp9908.txt", header = TRUE)

# 轉換為時間序列格式
data$date <- as.Date(as.character(data$date), format = "%Y%m%d")
data_xts <- xts(data[, -1], order.by = data$date)

data_xts <- data_xts[!is.na(data_xts$sp) & !is.nan(data_xts$sp) & !is.infinite(data_xts$sp)]

# 檢查ARCH效應
arch_test <- ArchTest(data_xts$sp, lags = 10)

# 顯示結果
print(arch_test)
```
  
(b)
```{r}
# 設定 GARCH(1,1) 模型
spec <- ugarchspec(variance.model = list(model = "sGARCH", garchOrder = c(1, 1)),
                   mean.model = list(armaOrder = c(0, 0)),
                   distribution.model = "norm")

# 估計 GARCH(1,1) 模型
fit <- ugarchfit(spec, data_xts$sp)

# 顯示結果
print(fit)
```
  
(c)
```{r}
# 計算 1 步到 4 步的預測
forecast <- ugarchforecast(fit, n.ahead = 4)

# 顯示預測結果
print(forecast)

# 提取預測的簡單收益率和波動性
predicted_returns <- forecast@forecast$seriesFor
predicted_volatility <- forecast@forecast$sigmaFor

# 顯示預測的簡單收益率
print("預測的簡單收益率:")
print(predicted_returns)

# 顯示預測的波動性
print("預測的波動性:")
print(predicted_volatility)
```